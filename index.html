<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0d0d0d">
    <meta name="robots" content="noindex, nofollow">
    <title>BoxBall Pro Championship</title>
    
    <link rel="manifest" href='data:application/manifest+json,{
        "name": "BoxBall Pro",
        "short_name": "BoxBall",
        "start_url": ".",
        "display": "standalone",
        "background_color": "#0d0d0d",
        "theme_color": "#0d0d0d",
        "orientation": "landscape",
        "icons": [{
            "src": "https://cdn-icons-png.flaticon.com/512/1089/1089129.png",
            "sizes": "512x512",
            "type": "image/png"
        }]
    }'>

    <style>
        body {
            background-color: #0d0d0d; color: #ffffff; font-family: 'Segoe UI', Roboto, sans-serif;
            margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; overflow: hidden; touch-action: manipulation; user-select: none;
        }
        h1 { margin: 0; font-size: 1.8rem; color: #00e5ff; text-transform: uppercase; letter-spacing: 1px; }
        h2 { margin: 10px 0; font-size: 1.4rem; }
        .big-text { font-size: 3rem; font-weight: bold; color: #fff; }
        .screen { display: none; width: 100%; max-width: 700px; text-align: center; height: 100%; flex-direction: column; justify-content: center; align-items: center; transition: background-color 0.3s ease; }
        .active { display: flex; }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 90%; margin-top: 10px; }
        button {
            background: linear-gradient(135deg, #ff0055, #ff4400); border: none; padding: 15px; color: white;
            font-size: 1.1rem; font-weight: bold; border-radius: 15px; cursor: pointer; width: 100%;
            box-shadow: 0 4px 15px rgba(255, 68, 0, 0.4); text-transform: uppercase;
        }
        button:active { transform: scale(0.96); }
        button.green { background: linear-gradient(135deg, #00b09b, #96c93d); box-shadow: 0 4px 15px rgba(150, 201, 61, 0.4); }
        button.blue { background: linear-gradient(135deg, #0072ff, #00c6ff); box-shadow: 0 4px 15px rgba(0, 198, 255, 0.4); }
        button.secondary { background: #333; box-shadow: none; border: 1px solid #555; width: auto; min-width: 150px; }
        input, select { background: #222; color: white; border: 1px solid #444; padding: 10px; border-radius: 8px; text-align: center; font-size: 1rem; }
        
        /* Game Screen Styles */
        #screen-game.playing { background-color: #2e7d32; } /* Verde Juego */
        #screen-game.finished { background-color: #c62828; } /* Rojo Fin */
        
        .counter-circle {
            background: white; width: 280px; height: 280px; border-radius: 50%; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin: 20px 0;
        }
        #counter { font-size: 8rem; font-weight: 800; line-height: 1; margin: 0; color: #333; transition: color 0.2s; }
        #timer { font-size: 2rem; color: #666; font-family: monospace; font-weight: bold; }
        
        .mic-container { width: 90%; background: #222; height: 40px; border-radius: 8px; overflow: hidden; margin-top: 10px; position: relative; border: 1px solid #444; display: flex; align-items: center; }
        #mic-level { height: 100%; background: #00ff00; width: 0%; transition: width 0.05s linear; opacity: 0.8; }
        #threshold-line { position: absolute; top:0; bottom:0; width:4px; background:#ff0055; z-index:2; left: 30%; }
        
        .calib-counter-box { position: absolute; right: 10px; color: #fff; font-family: monospace; font-size: 1.2rem; font-weight: bold; z-index: 5; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 4px; cursor: pointer; border: 1px solid #555; }
        .calib-counter-box:active { background: #555; }

        .scrollable { overflow-y: auto; max-height: 40vh; width: 90%; background: #111; padding: 10px; border-radius: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { padding: 6px; border-bottom: 1px solid #333; text-align: center; }
        th { color: #888; text-transform: uppercase; font-size: 0.7rem; }
        .row-highlight { background: rgba(0, 229, 255, 0.15); color: #00e5ff; font-weight: bold; }
        
        #countdown-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; justify-content: center; align-items: center; z-index: 1000; }
        #countdown-number { font-size: 12rem; font-weight: bold; animation: pop 0.4s ease-out; }
        @keyframes pop { 0% { transform: scale(0); opacity: 0; } 80% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="countdown-overlay"><div id="countdown-number">3</div></div>

    <div id="screen-main" class="screen active">
        <h1>BOXBALL PRO</h1>
        <p style="color:#aaa; font-size:0.8rem; margin-bottom: 10px;">Championship Edition</p>
        
        <div style="width: 90%; margin-bottom: 10px; background: #1a1a1a; padding: 15px; border-radius: 10px; box-sizing: border-box;">
            <p style="font-size:0.8rem; margin:0 0 5px 0; color:#fff; font-weight:bold;">CALIBRAR (GOLPEA PARA PROBAR)</p>
            <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#aaa;">
                <span>Izquierda: Muy Sensible</span>
                <span>Derecha: Menos Sensible</span>
            </div>
            <input type="range" id="sensitivity" min="1" max="100" value="15" style="width:100%; margin: 10px 0;">
            <div class="mic-container">
                <div id="mic-level"></div>
                <div id="threshold-line"></div>
                <div class="calib-counter-box" onclick="resetCalibCounter()"><span id="calib-counter-val">0</span> hits (Reset)</div>
            </div>
            <button id="btn-activate-mic" onclick="activateMicManual()" style="font-size:0.8rem; padding: 10px; margin-top:5px; background: #333; border: 1px solid #555; width:100%;">üî¥ ACTIVAR MICROFONO</button>
        </div>

        <button onclick="showScreen('screen-quick-select')" class="blue">‚ö° PARTIDA R√ÅPIDA</button>
        <button onclick="showScreen('screen-setup-tournament')" class="green">üèÜ TORNEO MULTIJUGADOR</button>
        <button onclick="showHistory()" class="secondary">üìú R√âCORDS</button>
    </div>

    <div id="screen-quick-select" class="screen">
        <h2>PARTIDA R√ÅPIDA</h2>
        <div class="btn-grid">
            <button onclick="startQuickGame('5s')">‚è±Ô∏è 5 Segundos</button>
            <button onclick="startQuickGame('10s')">‚è±Ô∏è 10 Segundos</button>
            <button onclick="startQuickGame('100h')" style="background: linear-gradient(135deg, #aa00ff, #5500ff);">üíØ 100 GOLPES</button>
            <button onclick="showScreen('screen-main')" class="secondary">üîô Volver</button>
        </div>
    </div>

    <div id="screen-setup-tournament" class="screen">
        <h2>CONFIGURAR TORNEO</h2>
        <div style="display:flex; gap:5px; justify-content:center; width:90%; margin-bottom:10px;">
            <div style="flex:1;"><label style="font-size:0.8rem">Jugadores</label><br><input type="number" id="num-players" value="2" min="1" max="20" onchange="generatePlayerInputs()" style="width:50px"></div>
            <div style="flex:1;"><label style="font-size:0.8rem">Rondas</label><br><input type="number" id="num-rounds" value="3" min="1" max="10" style="width:50px"></div>
            <div style="flex:2;"><label style="font-size:0.8rem">Puntuaci√≥n</label><br>
                <select id="score-mode" style="width:100%">
                    <option value="max">Mejor Ronda</option>
                    <option value="sum">Suma Total</option>
                </select>
            </div>
        </div>
        <div id="player-inputs-container" class="scrollable" style="height: 150px;"></div>
        <div style="display:flex; gap:10px; width:90%; margin-top:10px;">
            <button onclick="initTournament()" class="green">EMPEZAR</button>
            <button onclick="showScreen('screen-main')" class="secondary">VOLVER</button>
        </div>
    </div>

    <div id="screen-history" class="screen">
        <h2>R√âCORDS</h2>
        <div class="scrollable">
            <table id="history-table"></table>
        </div>
        <button onclick="clearHistory()" class="secondary" style="margin-top:10px">Borrar Todo</button>
        <button onclick="showScreen('screen-main')" class="secondary">Volver</button>
    </div>

    <div id="screen-transition" class="screen">
        <h3>SIGUIENTE TURNO</h3>
        <h1 id="trans-player-name" class="big-text" style="color: #00e5ff;">Pepe</h1>
        <div style="background: #222; padding: 15px; border-radius: 10px; width: 90%; margin: 10px 0;">
            <p style="margin:5px">RONDA <span id="trans-round" class="highlight">1</span></p>
        </div>
        <button onclick="runCountdownAndStart()" class="green" style="font-size: 1.5rem; padding: 20px;">¬°JUGAR!</button>
        <div style="width: 100%; margin-top: 10px;">
            <h3 id="leaderboard-title">CLASIFICACI√ìN</h3>
            <div class="scrollable" style="max-height: 20vh;">
                <table id="mini-leaderboard"></table>
            </div>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div style="position: absolute; top: 15px; width: 100%; display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box; z-index: 10;">
            <span id="game-player-name" style="color:rgba(255,255,255,0.8); font-weight:bold;">Jugador</span>
            <span id="game-mode-display" style="color:rgba(255,255,255,0.8);"></span>
        </div>
        
        <div class="counter-circle">
            <div id="counter">0</div>
            <div id="timer">0.00</div>
        </div>
        
        <button onclick="abortGame()" class="secondary" style="margin-top: 30px; opacity: 0.8; background:rgba(0,0,0,0.5); border:1px solid white;">CANCELAR</button>
    </div>

    <div id="screen-result" class="screen">
        <h2 id="result-title">¬°FIN!</h2>
        <h1 id="result-score" style="font-size: 6rem; margin: 0;">0</h1>
        <p id="result-subtext" style="color:#aaa; font-size: 1rem; margin-top: -10px;">PUNTOS</p>
        <p id="record-message" style="color: #ffff00; font-size: 1.2rem; min-height: 25px; margin: 10px 0;"></p>
        <div id="result-actions" style="width:90%"></div>
    </div>

    <script>
        const sfxCtx = new (window.AudioContext || window.webkitAudioContext)();
        let audioContext, analyser, microphone, dataArray;
        let lastHitT = 0;
        let previousEnergy = 0;
        let triggerThreshold = 15;
        let calibCounter = 0;
        let micActive = false;

        function speak(text, rate = 1.2, pitch = 1.0) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'es-ES'; u.rate = rate; u.pitch = pitch; u.volume = 1.0;
                window.speechSynthesis.speak(u);
            }
        }

        function playBuzzer() {
            const osc = sfxCtx.createOscillator();
            const gain = sfxCtx.createGain();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(100, sfxCtx.currentTime);
            gain.gain.setValueAtTime(0.5, sfxCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, sfxCtx.currentTime + 0.5);
            osc.connect(gain); gain.connect(sfxCtx.destination);
            osc.start(); osc.stop(sfxCtx.currentTime + 0.5);
        }

        function playHitSound() {
            const osc = sfxCtx.createOscillator();
            const gain = sfxCtx.createGain();
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(800, sfxCtx.currentTime); 
            gain.gain.setValueAtTime(0.6, sfxCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, sfxCtx.currentTime + 0.03); 
            osc.connect(gain); gain.connect(sfxCtx.destination);
            osc.start(); osc.stop(sfxCtx.currentTime + 0.03);
        }

        const DB_KEY = 'boxball_db_v7';
        let gameState = { mode: '10s', target: 10, score: 0, startTime: 0, isPlaying: false };
        let tournamentData = null;

        function saveRecord(player, score, mode) {
            let db = JSON.parse(localStorage.getItem(DB_KEY) || "[]");
            db.unshift({ date: new Date().toLocaleDateString(), player, score, mode, ts: Date.now() });
            if(db.length > 200) db.pop();
            localStorage.setItem(DB_KEY, JSON.stringify(db));
            return true; 
        }

        async function initAudio() {
            if(audioContext) return;
            const constraintsPro = { audio: { echoCancellation: false, autoGainControl: false, noiseSuppression: false, latency: 'interactive' } };
            const constraintsBasic = { audio: true };
            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraintsPro);
                setupStream(stream);
            } catch(e) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia(constraintsBasic);
                    setupStream(stream);
                } catch(err) { alert("ERROR: No se puede acceder al micr√≥fono."); }
            }
        }

        function setupStream(stream) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            microphone = audioContext.createMediaStreamSource(stream);
            const filter = audioContext.createBiquadFilter();
            filter.type = 'bandpass'; filter.frequency.value = 600; filter.Q.value = 1.0;
            microphone.connect(filter); filter.connect(analyser);
            analyser.fftSize = 512;
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            micActive = true;
            detectLoop();
            document.getElementById('btn-activate-mic').style.display = 'none';
        }

        function activateMicManual() {
            initAudio();
            calibCounter = 0;
            document.getElementById('calib-counter-val').innerText = "0";
        }
        
        function resetCalibCounter() {
            calibCounter = 0;
            document.getElementById('calib-counter-val').innerText = "0";
        }

        function detectLoop() {
            requestAnimationFrame(detectLoop);
            if(!analyser) return;
            analyser.getByteFrequencyData(dataArray);
            
            let sum = 0; for(let i = 0; i < dataArray.length; i++) sum += dataArray[i];
            let currentEnergy = sum / dataArray.length;
            let impactForce = Math.max(0, currentEnergy - previousEnergy); 
            let sliderVal = parseInt(document.getElementById('sensitivity').value);
            triggerThreshold = 2 + (sliderVal * 0.5); 

            if(document.getElementById('screen-main').classList.contains('active')) {
                document.getElementById('mic-level').style.width = Math.min(impactForce * 5, 100) + '%'; 
                document.getElementById('threshold-line').style.left = Math.min(triggerThreshold * 5, 100) + '%';
            }

            let now = Date.now();
            if(impactForce > triggerThreshold && (now - lastHitT > 60)) {
                lastHitT = now;
                if(gameState.isPlaying) {
                    registerHit();
                } else if(micActive && document.getElementById('screen-main').classList.contains('active')) {
                    calibCounter++;
                    document.getElementById('calib-counter-val').innerText = calibCounter;
                    playHitSound();
                    const bar = document.getElementById('mic-level');
                    bar.style.backgroundColor = '#fff';
                    setTimeout(()=> bar.style.backgroundColor = '#00ff00', 100);
                }
            }
            previousEnergy = currentEnergy; 
        }

        function registerHit() {
            gameState.score++;
            document.getElementById('counter').innerText = gameState.score;
            playHitSound();
            if(gameState.mode === '100h' && gameState.score >= 100) endGame();
        }

        function startQuickGame(mode) {
            gameState.mode = mode;
            tournamentData = { players: [{name: "Jugador", scores: {}, total: 0}], config: {rounds: 1, type: 'max'}, state: {pIdx: 0, round: 1} };
            initAudio().then(showTransitionScreen);
        }

        function initTournament() {
            const pCount = document.getElementById('num-players').value;
            const pNames = [];
            for(let i=1; i<=pCount; i++) pNames.push({ name: document.getElementById(`pname-${i}`).value, scores: {}, total: 0 });
            tournamentData = {
                players: pNames,
                config: { rounds: parseInt(document.getElementById('num-rounds').value), type: document.getElementById('score-mode').value },
                state: { pIdx: 0, round: 1 }
            };
            gameState.mode = '10s';
            initAudio().then(showTransitionScreen);
        }

        function runCountdownAndStart() {
            const ol = document.getElementById('countdown-overlay');
            const num = document.getElementById('countdown-number');
            ol.style.display = 'flex';
            let c = 3; num.innerText = c; speak("Tres");
            let i = setInterval(() => {
                c--;
                if(c>0) { num.innerText=c; speak(c==2?"Dos":"Uno"); } 
                else {
                    clearInterval(i);
                    num.innerText="GO!!"; speak("¬°GO!", 1.5);
                    setTimeout(()=> { ol.style.display='none'; startGameLoop(); }, 600);
                }
            }, 1000);
        }

        function startGameLoop() {
            showScreen('screen-game');
            const screenGame = document.getElementById('screen-game');
            screenGame.className = "screen active playing";
            gameState.score = 0;
            gameState.isPlaying = true;
            gameState.startTime = Date.now();
            document.getElementById('counter').innerText = "0";
            document.getElementById('counter').style.color = "#2e7d32";
            
            let limit = gameState.mode === '5s' ? 5 : 10;
            let countUp = gameState.mode === '100h';

            window.gameInt = setInterval(() => {
                let elapsed = (Date.now() - gameState.startTime) / 1000;
                if(countUp) {
                    document.getElementById('timer').innerText = elapsed.toFixed(2);
                } else {
                    let remain = limit - elapsed;
                    if(remain <= 0) { document.getElementById('timer').innerText = "0.00"; endGame(); }
                    else { document.getElementById('timer').innerText = remain.toFixed(2); }
                }
            }, 30);
        }

        function endGame() {
            gameState.isPlaying = false;
            clearInterval(window.gameInt);
            playBuzzer();
            const screenGame = document.getElementById('screen-game');
            screenGame.className = "screen active finished";
            document.getElementById('counter').style.color = "#c62828";
            
            let val = gameState.mode === '100h' ? (Date.now() - gameState.startTime) / 1000 : gameState.score;
            setTimeout(() => {
                showScreen('screen-result');
                document.getElementById('result-score').innerText = gameState.mode === '100h' ? val.toFixed(2) + "s" : val;
                speak(val + (gameState.mode === '100h' ? " segundos" : " puntos"));
                processResults(val);
            }, 1500);
        }

        function processResults(val) {
            const state = tournamentData.state;
            const player = tournamentData.players[state.pIdx];
            saveRecord(player.name, val, gameState.mode);
            let currentRoundBest = player.scores[state.round] || (gameState.mode === '100h' ? 9999 : 0);
            let isBetter = (gameState.mode === '100h') ? (val < currentRoundBest) : (val > currentRoundBest);
            if(isBetter || !player.scores[state.round]) {
                player.scores[state.round] = val;
            }
            if(tournamentData.config.type === 'sum') {
                player.total = Object.values(player.scores).reduce((a,b) => parseFloat(a)+parseFloat(b), 0);
            } else {
                let allScores = Object.values(player.scores);
                if(allScores.length > 0) player.total = (gameState.mode === '100h') ? Math.min(...allScores) : Math.max(...allScores);
            }
            
            let nextText = "SIGUIENTE";
            let action = null;
            if(state.pIdx < tournamentData.players.length - 1) {
                state.pIdx++; nextText = `TURNO: ${tournamentData.players[state.pIdx].name}`; action = showTransitionScreen;
            } else if(state.round < tournamentData.config.rounds) {
                state.pIdx = 0; state.round++; nextText = "SIGUIENTE RONDA"; action = showTransitionScreen;
            } else {
                nextText = "VER PODIO FINAL"; action = showFinalPodium;
            }
            
            const container = document.getElementById('result-actions');
            container.innerHTML = '';
            const btn = document.createElement('button');
            btn.className = 'green';
            btn.innerText = nextText;
            btn.onclick = action;
            container.appendChild(btn);
        }

        function showTransitionScreen() {
            showScreen('screen-transition');
            document.getElementById('trans-player-name').innerText = tournamentData.players[tournamentData.state.pIdx].name;
            document.getElementById('trans-round').innerText = `${tournamentData.state.round} / ${tournamentData.config.rounds}`;
            updateLeaderboard();
        }

        function updateLeaderboard() {
            const tbl = document.getElementById('mini-leaderboard');
            let isTime = gameState.mode === '100h';
            let sorted = [...tournamentData.players].sort((a,b) => isTime ? a.total - b.total : b.total - a.total);
            let html = `<tr><th>#</th><th>JUGADOR</th><th>TOTAL</th></tr>`;
            sorted.forEach((p, idx) => {
                html += `<tr class="${p.name === tournamentData.players[tournamentData.state.pIdx].name ? 'row-highlight' : ''}">
                    <td>${idx+1}</td><td>${p.name}</td><td>${p.total.toFixed(isTime ? 2 : 0)}</td></tr>`;
            });
            tbl.innerHTML = html;
        }

        function showFinalPodium() {
            showScreen('screen-transition');
            document.getElementById('trans-player-name').innerText = "üèÜ CLASIFICACI√ìN FINAL üèÜ";
            document.querySelector('#screen-transition button').innerText = "REINICIAR";
            document.querySelector('#screen-transition button').onclick = () => location.reload();
            updateLeaderboard();
        }

        function generatePlayerInputs() {
            const n = document.getElementById('num-players').value;
            const c = document.getElementById('player-inputs-container');
            c.innerHTML = "";
            for(let i=1; i<=n; i++) c.innerHTML += `<input type="text" id="pname-${i}" value="Jugador ${i}" style="width:90%; margin:2px">`;
        }
        setTimeout(generatePlayerInputs, 100);

        function showHistory() {
            showScreen('screen-history');
            const db = JSON.parse(localStorage.getItem(DB_KEY)||"[]");
            const tbl = document.getElementById('history-table');
            let h = "<tr><th>MODO</th><th>JUGADOR</th><th>RES</th></tr>";
            db.slice(0, 10).forEach(r => { h += `<tr><td>${r.mode}</td><td>${r.player}</td><td>${r.score}</td></tr>`; });
            tbl.innerHTML = h;
        }
        function clearHistory() { localStorage.removeItem(DB_KEY); showHistory(); }
        function abortGame() { clearInterval(window.gameInt); gameState.isPlaying=false; showScreen('screen-main'); }
        function showScreen(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    </script>
</body>
</html>